{{ define "main" }}
<div class="login-container">
    <h1>{{ .Title }}</h1>
    {{ .Content }}
    
    <div id="privy-login">
        <div id="login-buttons" class="login-buttons">
            <button id="email-login" class="button">
                Login with Email
            </button>
            <button id="wallet-login" class="button">
                Connect Wallet
            </button>
        </div>
        <div id="email-form" style="display: none;">
            <div class="input-group">
                <label for="email">Email Address</label>
                <input type="email" id="email">
            </div>
            <button id="send-email" class="button">Send Login Link</button>
            <button id="back-to-options" class="button secondary">Back</button>
        </div>
        <div id="status-message"></div>
    </div>
</div>

<style>
.login-container {
    max-width: 500px;
    margin: 2rem auto;
    padding: 1rem;
}

.login-buttons {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin: 2rem 0;
}

.button {
    background: #333;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.button:hover {
    background: #555;
}

.button.secondary {
    background: transparent;
    color: #333;
    border: 1px solid #333;
}

.input-group {
    margin: 1rem 0;
}

.input-group label {
    display: block;
    margin-bottom: 0.5rem;
}

.input-group input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

#status-message {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 4px;
}

.error {
    background: #ffebee;
    color: #c62828;
}

.success {
    background: #e8f5e9;
    color: #2e7d32;
}
</style>

<script>
// Constants for Privy API
const PRIVY_APP_ID = 'client-WY2fr1iUtnzfTBZERvcJvo37SUfw8gaCzT9Cn7ri4bTLa'; // Replace with your Privy App ID
const PRIVY_API_URL = 'https://auth.privy.io/api/v1';

// DOM Elements
const emailLoginBtn = document.getElementById('email-login');
const walletLoginBtn = document.getElementById('wallet-login');
const emailForm = document.getElementById('email-form');
const loginButtons = document.getElementById('login-buttons');
const emailInput = document.getElementById('email');
const sendEmailBtn = document.getElementById('send-email');
const backBtn = document.getElementById('back-to-options');
const statusMessage = document.getElementById('status-message');

// Event Listeners
emailLoginBtn.addEventListener('click', showEmailForm);
walletLoginBtn.addEventListener('click', initiateWalletLogin);
sendEmailBtn.addEventListener('click', sendLoginEmail);
backBtn.addEventListener('click', showLoginOptions);

// Functions
function showEmailForm() {
    loginButtons.style.display = 'none';
    emailForm.style.display = 'block';
}

function showLoginOptions() {
    loginButtons.style.display = 'flex';
    emailForm.style.display = 'none';
    clearStatus();
}

function clearStatus() {
    statusMessage.textContent = '';
    statusMessage.className = '';
}

async function sendLoginEmail() {
    const email = emailInput.value;
    if (!email || !validateEmail(email)) {
        showStatus('Please enter a valid email address', 'error');
        return;
    }

    try {
        showStatus('Sending login link...', 'info');
        
        const response = await fetch(`${PRIVY_API_URL}/auth/create-verification`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'privy-app-id': PRIVY_APP_ID
            },
            body: JSON.stringify({
                method: 'email',
                email: email,
                redirect_uri: window.location.origin + '/dashboard', // Redirect after login
                subject: 'Login to Black Flag',
                message: 'Click the link to login to your Black Flag account'
            })
        });

        const data = await response.json();
        
        if (response.ok) {
            showStatus('Login link sent! Please check your email.', 'success');
        } else {
            throw new Error(data.message || 'Failed to send login link');
        }
    } catch (error) {
        showStatus(error.message, 'error');
    }
}

async function initiateWalletLogin() {
    showStatus('Opening wallet connection...', 'info');
    
    try {
        // This would ideally use a wallet provider like Web3Modal or WalletConnect
        // For simplicity, we're showing a basic approach
        if (!window.ethereum) {
            throw new Error('No wallet detected. Please install a Web3 wallet like MetaMask.');
        }
        
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const address = accounts[0];
        
        // After getting the address, you would:
        // 1. Generate a message for signing
        // 2. Have the user sign it
        // 3. Verify the signature with Privy

        const message = `Sign this message to authenticate with Black Flag: ${Date.now()}`;
        const signature = await window.ethereum.request({
            method: 'personal_sign',
            params: [message, address]
        });
        
        // Verify with Privy
        const response = await fetch(`${PRIVY_API_URL}/auth/wallet`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'privy-app-id': PRIVY_APP_ID
            },
            body: JSON.stringify({
                wallet_address: address,
                message: message,
                signature: signature,
                chain_id: window.ethereum.chainId || '0x1' // Default to Ethereum mainnet
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Save token and redirect
            localStorage.setItem('privy_token', data.token);
            window.location.href = '/dashboard';
        } else {
            throw new Error(data.message || 'Wallet authentication failed');
        }
    } catch (error) {
        showStatus(error.message, 'error');
    }
}

function validateEmail(email) {
    return /\S+@\S+\.\S+/.test(email);
}

function showStatus(message, type) {
    statusMessage.textContent = message;
    statusMessage.className = type;
}
</script>
{{ end }}